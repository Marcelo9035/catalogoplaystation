<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Catálogo de Jogos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (UMD version for browser) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- SheetJS with Style Support (Para Exportação Excel Bonita) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: white;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
            border: 2px solid #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { box-shadow: 0 0 40px rgba(147, 51, 234, 0.8); }
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s ease-out forwards;
        }
        .animate-slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }
        .animate-pulse-glow {
            animation: pulse-glow 3s infinite;
        }

        /* Custom Line Clamp to avoid Tailwind conflicts */
        .synopsis-clamp {
            display: -webkit-box !important;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen selection:bg-blue-600 selection:text-white overflow-x-hidden">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-24 right-4 z-[70] flex flex-col gap-2 pointer-events-none">
        <!-- Toasts injected here -->
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 px-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-slate-900 rounded-xl shadow-2xl border border-slate-800 p-8 space-y-6 animate-zoom-in">
            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-blue-600 rounded-lg mx-auto flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.5)] mb-4 transition-all duration-300 hover:shadow-[0_0_30px_rgba(37,99,235,1)] hover:brightness-125 hover:scale-105 cursor-pointer">
                     <img 
                        src="https://raw.githubusercontent.com/Marcelo9035/IMAGES/refs/heads/main/pngwing.com.png" 
                        alt="Logo" 
                        class="w-10 h-10 object-contain filter drop-shadow-md"
                        onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/4/4e/Playstation_logo_colour.svg'" 
                    />
                </div>
                <h1 class="text-2xl font-bold text-white">Bem-vindo de volta</h1>
                <p class="text-slate-400">Entre para acessar seu catálogo</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div class="space-y-2">
                    <label for="email" class="text-sm font-medium text-slate-300">Email</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                            <i data-lucide="mail" class="w-4 h-4"></i>
                        </span>
                        <input type="email" id="email" required class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-slate-600" placeholder="seu@email.com">
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label for="password" class="text-sm font-medium text-slate-300">Senha</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                            <i data-lucide="lock" class="w-4 h-4"></i>
                        </span>
                        <input type="password" id="password" required class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-slate-600" placeholder="••••••••">
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="button" onclick="showResetScreen()" class="text-sm text-blue-400 hover:text-blue-300 hover:underline transition-all">
                        Esqueceu a senha?
                    </button>
                </div>

                <div id="login-error" class="hidden text-red-400 text-sm text-center bg-red-950/30 p-2 rounded border border-red-900/50 flex items-center justify-center gap-2 animate-pulse">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span>Credenciais inválidas.</span>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-4 rounded-lg shadow-lg shadow-blue-600/20 transition-all duration-200 transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Entrar</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- TELA DE REDEFINIÇÃO DE SENHA (Inicialmente Oculta) -->
    <div id="reset-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950 px-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-slate-900 rounded-xl shadow-2xl border border-slate-800 p-8 space-y-6 animate-zoom-in">
            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">
                    <i data-lucide="key-round" class="w-8 h-8 text-blue-500"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Redefinir Senha</h1>
                <p class="text-slate-400">Informe seu e-mail para receber o link.</p>
            </div>

            <form onsubmit="handleResetSubmit(event)" class="space-y-4">
                <div class="space-y-2">
                    <label for="reset-email" class="text-sm font-medium text-slate-300">Email Cadastrado</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                            <i data-lucide="mail" class="w-4 h-4"></i>
                        </span>
                        <input type="email" id="reset-email" required class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-slate-600" placeholder="seu@email.com">
                    </div>
                </div>

                <div id="reset-message" class="hidden text-sm text-center p-3 rounded border flex items-center justify-center gap-2">
                    <!-- Mensagem injetada via JS -->
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-4 rounded-lg shadow-lg shadow-blue-600/20 transition-all duration-200 transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Enviar Link</span>
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>

                <button type="button" onclick="showLoginScreen()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium py-2.5 px-4 rounded-lg border border-slate-700 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>Voltar para o Login</span>
                </button>
            </form>
        </div>
    </div>

    <!-- CONTEÚDO DO APP (Inicialmente Oculto) -->
    <div id="app-content" class="hidden animate-fade-in relative">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-slate-950 to-slate-900 border-b border-slate-800 sticky top-0 z-40 shadow-xl">
            <div class="container mx-auto px-4 py-6 flex flex-col lg:flex-row items-center justify-between gap-4 relative">
                <div class="flex items-center gap-3 w-full lg:w-auto justify-center lg:justify-start relative z-50">
                    <!-- PlayStation Logo Container (TRIGGER) -->
                    <div onclick="toggleHeaderButtons()" class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.5)] overflow-hidden shrink-0 transition-all duration-300 hover:shadow-[0_0_30px_rgba(37,99,235,1)] hover:brightness-125 hover:scale-105 cursor-pointer" title="Clique para Menu de Opções">
                        <img 
                            src="https://raw.githubusercontent.com/Marcelo9035/IMAGES/refs/heads/main/pngwing.com.png" 
                            alt="PlayStation Logo" 
                            class="w-8 h-8 object-contain filter drop-shadow-md"
                            onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/4/4e/Playstation_logo_colour.svg'" 
                        />
                    </div>
                    <h1 class="text-xl md:text-2xl lg:text-3xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-600 uppercase cursor-pointer whitespace-nowrap" onclick="resetFilter()">
                        MEU CATÁLOGO DE JOGOS
                    </h1>

                    <!-- DROPDOWN MENU (Hidden by default) -->
                    <div id="header-buttons" class="hidden absolute top-14 left-0 mt-2 w-64 bg-slate-900/95 backdrop-blur-md border border-slate-700 rounded-xl shadow-2xl p-4 flex flex-col gap-3 animate-zoom-in z-[100]">
                        
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-slate-700 pb-2 flex justify-between items-center">
                            <span>Menu de Ações</span>
                            <span class="flex items-center gap-1 text-blue-400"><i data-lucide="gamepad-2" class="w-3 h-3"></i> <span id="game-count">0</span></span>
                        </div>

                        <!-- ACTION BUTTONS GROUP -->
                        <div class="flex flex-col gap-2">
                            <!-- ADD GAME Button -->
                            <button onclick="openAddGameModal()" class="flex items-center gap-3 bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg transition-all shadow-lg active:scale-95 w-full justify-start" title="Adicionar Novo Jogo">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                <span class="font-semibold">Novo Jogo</span>
                            </button>

                            <!-- EDIT MODE Button -->
                            <button id="btn-edit-mode" onclick="toggleEditMode()" class="flex items-center gap-3 bg-slate-700 hover:bg-amber-600 text-slate-300 hover:text-white px-3 py-2 rounded-lg transition-all active:scale-95 w-full justify-start" title="Modo de Edição">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                                <span class="font-semibold">Alterar Jogos</span>
                            </button>

                            <!-- DELETE MODE Button -->
                            <button id="btn-delete-mode" onclick="toggleDeleteMode()" class="flex items-center gap-3 bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white px-3 py-2 rounded-lg transition-all active:scale-95 w-full justify-start" title="Modo de Exclusão">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span class="font-semibold">Excluir Jogos</span>
                            </button>
                        </div>

                        <div class="h-px bg-slate-700 my-1"></div>

                        <!-- SAVE Button -->
                        <button id="save-btn" onclick="handleManualSave()" class="flex items-center gap-3 px-3 py-2 rounded-lg transition-all shadow-lg transform active:scale-95 bg-emerald-600 hover:bg-emerald-500 text-white border border-emerald-500 w-full justify-start" title="Salvar manualmente">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span class="font-semibold">Salvar Dados</span>
                        </button>

                        <!-- Backup Button -->
                        <button onclick="downloadBackup()" class="flex items-center gap-3 bg-sky-600/90 hover:bg-sky-500 text-white px-3 py-2 rounded-lg transition-colors shadow-lg shadow-sky-900/20 w-full justify-start" title="Baixar Backup JSON Completo">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span class="font-semibold">Backup JSON</span>
                        </button>

                        <!-- Restore Button -->
                        <button onclick="document.getElementById('restore-input').click()" class="flex items-center gap-3 bg-violet-600/90 hover:bg-violet-500 text-white px-3 py-2 rounded-lg transition-colors shadow-lg shadow-violet-900/20 w-full justify-start" title="Restaurar de Arquivo HTML">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            <span class="font-semibold">Restaurar</span>
                        </button>
                        <input type="file" id="restore-input" accept=".json,.html" class="hidden" onchange="handleRestore(this)">

                        <!-- Export Button -->
                        <button onclick="exportToExcel()" class="flex items-center gap-3 bg-emerald-600/90 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg transition-colors shadow-lg shadow-emerald-900/20 w-full justify-start" title="Baixar Excel com Gráficos">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                            <span class="font-semibold">Exportar Excel</span>
                        </button>

                        <div class="h-px bg-slate-700 my-1"></div>

                        <!-- Logout Button -->
                        <button onclick="handleLogout()" class="flex items-center gap-3 bg-red-600/10 hover:bg-red-600/30 text-red-400 hover:text-red-200 px-3 py-2 rounded-lg transition-colors w-full justify-start" title="Sair">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span class="font-semibold">Sair</span>
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row items-center gap-3 w-full lg:w-auto relative z-40">
                    
                    <!-- Search Bar -->
                    <div class="relative group w-full md:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Pesquisar jogo..." 
                            oninput="handleSearch(this.value)"
                            onkeydown="if(event.key === 'Enter') this.blur()"
                            class="w-full bg-slate-800 border border-slate-700 text-white py-2 pl-10 pr-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm placeholder-slate-500 transition-all hover:bg-slate-700/80"
                        />
                    </div>

                    <!-- Filter Dropdown -->
                    <div class="relative group w-full md:w-auto">
                        <select id="platform-filter" onchange="handleFilterChange(this.value)" class="w-full md:w-auto appearance-none bg-slate-800 border border-slate-700 text-white py-2 pl-4 pr-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium cursor-pointer hover:bg-slate-700 transition-colors">
                            <option value="ALL">Todas as Plataformas</option>
                            <!-- Options injected by JS -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                            <i data-lucide="filter" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mode Indicator Banner -->
            <div id="mode-indicator" class="hidden w-full text-center py-2 text-sm font-bold uppercase tracking-wider text-white transition-colors relative z-30">
                <!-- Injected via JS -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto px-4 py-8 relative z-0">
            
            <!-- HIGHLIGHT SECTION: JOGANDO ATUALMENTE -->
            <div id="playing-section" class="hidden mb-10 animate-fade-in">
                <!-- Injected via JS -->
            </div>

            <div id="games-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                <!-- Games will be inserted here by JS -->
            </div>
            <!-- Empty State Message -->
            <div id="empty-state" class="hidden w-full text-center py-20 text-slate-500">
                <i data-lucide="ghost" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                <p class="text-lg">Nenhum jogo encontrado.</p>
            </div>
        </main>

        <!-- Game Details Modal Backdrop -->
        <div id="modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden animate-fade-in">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
            
            <!-- Nav Buttons Desktop -->
            <button onclick="navigateGame(-1)" class="hidden md:flex absolute left-4 z-[60] text-white/50 hover:text-white bg-black/30 hover:bg-blue-600/80 p-3 rounded-full transition-all transform hover:scale-110 cursor-pointer">
                <i data-lucide="chevron-left" class="w-10 h-10"></i>
            </button>
            <button onclick="navigateGame(1)" class="hidden md:flex absolute right-4 z-[60] text-white/50 hover:text-white bg-black/30 hover:bg-blue-600/80 p-3 rounded-full transition-all transform hover:scale-110 cursor-pointer">
                <i data-lucide="chevron-right" class="w-10 h-10"></i>
            </button>

            <!-- Modal Content Container -->
            <div id="modal-content" class="bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-xl border border-slate-700 shadow-2xl flex flex-col md:flex-row relative z-50 animate-zoom-in overflow-hidden">
                <!-- Dynamic Content Injected Here -->
            </div>
        </div>

        <!-- ADD/EDIT GAME MODAL -->
        <div id="add-game-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden animate-fade-in">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddGameModal()"></div>
            
            <div class="bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-xl border border-slate-700 shadow-2xl flex flex-col md:flex-row relative z-[70] animate-zoom-in overflow-hidden">
                <button onclick="closeAddGameModal()" class="absolute top-4 right-4 z-50 bg-black/50 p-2 rounded-full text-white hover:bg-black/70 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <!-- Left Side: Cover Preview -->
                <div class="w-full md:w-1/3 bg-slate-950 p-6 flex flex-col items-center justify-center border-r border-slate-800">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Pré-visualização da Capa</h3>
                    <div class="relative w-full max-w-[200px] aspect-[3/4] bg-slate-800 rounded-lg overflow-hidden shadow-lg border border-slate-700 flex items-center justify-center group">
                        <img id="new-game-preview" src="" alt="Capa" class="w-full h-full object-cover hidden" />
                        <div id="new-game-placeholder" class="text-slate-600 flex flex-col items-center text-center p-4">
                            <i data-lucide="image" class="w-12 h-12 mb-2"></i>
                            <span class="text-xs">A imagem aparecerá aqui quando inserir a URL</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-4 text-center">Recomendado: Imagens verticais (Proporção 3:4)</p>
                </div>

                <!-- Right Side: Form -->
                <div class="flex-1 flex flex-col min-h-0 bg-slate-900">
                    <div class="p-6 border-b border-slate-800 bg-slate-900/95 sticky top-0 z-10">
                        <h2 id="modal-form-title" class="text-2xl font-bold text-white flex items-center gap-2">
                            <!-- JS will set title -->
                        </h2>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                        <input type="hidden" id="edit-game-id" value="">
                        
                        <!-- Basic Info -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-400 mb-1">Título do Jogo</label>
                                <!-- Added 'uppercase' class to input -->
                                <input type="text" id="new-title" onkeydown="if(event.key === 'Enter') handleSaveGame()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase" placeholder="EX: GOD OF WAR">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-400 mb-1">URL da Capa (Imagem)</label>
                                <input type="text" id="new-cover" oninput="updatePreview(this.value)" onkeydown="if(event.key === 'Enter') handleSaveGame()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="https://...">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-400 mb-1">Sinopse</label>
                                <textarea id="new-synopsis" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Uma breve descrição do jogo..."></textarea>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-1">Desenvolvedora</label>
                                    <input type="text" id="new-developer" onkeydown="if(event.key === 'Enter') handleSaveGame()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-1">Publicadora</label>
                                    <input type="text" id="new-publisher" onkeydown="if(event.key === 'Enter') handleSaveGame()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-1">Data de Lançamento</label>
                                    <input type="text" id="new-date" onkeydown="if(event.key === 'Enter') handleSaveGame()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="DD/MM/AAAA">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-1">Classificação Indicativa</label>
                                    <select id="new-age" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="Livre">Livre</option>
                                        <option value="Everyone">Everyone (Livre)</option>
                                        <option value="Everyone 10+">Everyone 10+</option>
                                        <option value="Teen">Teen (13+)</option>
                                        <option value="Mature">Mature (17+)</option>
                                        <option value="18+">18+</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Interactive Selectors -->
                        <div>
                            <label class="block text-sm font-medium text-blue-400 mb-2 uppercase tracking-wider">Plataformas</label>
                            <div id="new-platforms-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                <!-- JS will inject buttons here -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-blue-400 mb-2 uppercase tracking-wider">Áudio / Legendas</label>
                            <div id="new-audio-container" class="flex flex-wrap gap-2">
                                <!-- JS will inject buttons here -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-blue-400 mb-2 uppercase tracking-wider">Tipo de Mídia</label>
                            <div id="new-media-container" class="flex flex-wrap gap-2">
                                <!-- JS will inject buttons here -->
                            </div>
                        </div>
                    </div>

                    <div class="p-6 border-t border-slate-800 bg-slate-900/95 flex justify-end gap-3">
                        <button onclick="closeAddGameModal()" class="px-4 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800 transition-colors">Cancelar</button>
                        <button onclick="handleSaveGame()" id="modal-save-btn" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-transform active:scale-95 flex items-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i> Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GLOBAL UTILITIES AND HELPERS SCRIPT -->
    <script>
        // --- CONSTANTS & HELPERS ---
        window.MASTER_PLATFORM_LIST = [
            "PlayStation 2", "PlayStation 3", "PlayStation 4", "PlayStation 5",
            "PlayStation Portable (PSP)", "PlayStation Vita",
            "Xbox", "Xbox 360", "Xbox One", "Xbox Series X/S",
            "GameCube", "Wii", "Wii U", "Nintendo Switch", "Nintendo DS", "Game Boy Advance",
            "Microsoft Windows (PC)", "Mobile", "Stadia"
        ];

        window.normalizePlatform = (p) => {
            const lower = p.toLowerCase();
            if (lower.includes("windows") || lower.includes("pc")) return "Microsoft Windows (PC)";
            if (lower.includes("playstation 2") || lower === "ps2") return "PlayStation 2";
            if (lower.includes("playstation 3") || lower === "ps3") return "PlayStation 3";
            if (lower.includes("playstation 4") || lower === "ps4") return "PlayStation 4";
            if (lower.includes("playstation 5") || lower === "ps5") return "PlayStation 5";
            if (lower.includes("portable") || lower.includes("psp")) return "PlayStation Portable (PSP)";
            if (lower.includes("vita")) return "PlayStation Vita";
            if (lower.includes("xbox 360")) return "Xbox 360";
            if (lower.includes("xbox one")) return "Xbox One";
            if (lower.includes("series x") || lower.includes("series s")) return "Xbox Series X/S";
            if (lower === "xbox") return "Xbox";
            if (lower.includes("gamecube")) return "GameCube";
            if (lower.includes("wii u")) return "Wii U";
            if (lower.includes("wii")) return "Wii";
            if (lower.includes("switch")) return "Nintendo Switch";
            if (lower.includes("ds") && !lower.includes("3ds")) return "Nintendo DS";
            if (lower.includes("gba") || lower.includes("advance")) return "Game Boy Advance";
            if (lower.includes("celulares") || lower.includes("mobile") || lower.includes("iphone")) return "Mobile";
            if (lower.includes("stadia")) return "Stadia";
            return p;
        };

        window.getGameAge = (dateString) => {
            const yearMatch = dateString.match(/\d{4}/);
            if (yearMatch) {
                const releaseYear = parseInt(yearMatch[0], 10);
                const currentYear = new Date().getFullYear();
                const diff = currentYear - releaseYear;
                return diff <= 0 ? "Lançamento" : `${diff} anos`;
            }
            return "N/A";
        };

        window.getMediaColorClass = (platforms) => {
            const p = platforms.map(p => p.toLowerCase()).join(" ");
            if (p.includes("playstation 5")) return "bg-white text-black border-white shadow-[0_0_10px_rgba(255,255,255,0.6)]"; 
            if (p.includes("playstation 4")) return "bg-blue-600 text-white border-blue-500 shadow-[0_0_10px_rgba(37,99,235,0.6)]"; 
            if (p.includes("playstation 3")) return "bg-neutral-900 text-white border-neutral-600 shadow-[0_0_10px_rgba(0,0,0,0.8)]"; 
            if (p.includes("playstation 2")) return "bg-gray-600 text-white border-gray-500 shadow-[0_0_10px_rgba(75,85,99,0.6)]"; 
            return "bg-indigo-600 text-white border-indigo-500 shadow-[0_0_10px_rgba(79,70,229,0.4)]"; 
        };

        window.getDisplayCover = (game) => {
            const media = Array.isArray(game.mediaType) ? game.mediaType : [game.mediaType];

            if (game.id === 72 && media.includes("Digital")) return "https://cdn.thegamesdb.net/images/original/boxart/front/88519-1.jpg";
            if (game.id === 49) {
                if (media.includes("Físico") && !media.includes("Digital")) return "https://cdn.thegamesdb.net/images/original/boxart/front/22722-1.jpg";
                return game.cover;
            }
            if (game.id === 46 && media.includes("Digital")) return "https://cdn.thegamesdb.net/images/original/boxart/front/77205-1.jpg";
            if (game.id === 48) {
                if (media.includes("Digital")) return "https://gamesdb-images.launchbox.gg/r2_0f16a921-caec-4c3b-a5d6-452ff710b636.jpg";
                return "https://cdn.thegamesdb.net/images/original/boxart/front/69109-1.jpg";
            }
            return game.cover;
        };
        
        window.getGenerationScore = (platforms) => {
            const p = platforms.map(x => x.toLowerCase());
            // Gen 6 (PS2 Era)
            if (p.some(x => x.includes("playstation 2") || x.includes("gamecube") || (x === "xbox"))) return 1;
            // Gen 7 (PS3 Era)
            if (p.some(x => x.includes("playstation 3") || x.includes("xbox 360") || x.includes("wii") || x.includes("psp"))) return 2;
            // Gen 8 (PS4 Era)
            if (p.some(x => x.includes("playstation 4") || x.includes("xbox one") || x.includes("wii u") || x.includes("switch") || x.includes("vita"))) return 3;
            // Gen 9 (PS5 Era)
            if (p.some(x => x.includes("playstation 5") || x.includes("series"))) return 4;
            return 5; // PC/Mobile/Other
        };

        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgClass = 'bg-blue-600';
            if (type === 'success') bgClass = 'bg-emerald-600';
            if (type === 'warning') bgClass = 'bg-amber-600';
            if (type === 'error') bgClass = 'bg-red-600';
            if (type === 'info') bgClass = 'bg-sky-600';
            
            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] animate-slide-in-right`;
            toast.innerHTML = `<div class="bg-white/20 p-1 rounded-full"><i data-lucide="${type === 'success' ? 'check' : 'info'}" class="w-4 h-4"></i></div><span class="font-medium text-sm">${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // Initial Data
        window.initialGamesData = [
            { id: 5, title: "Altered Beast", cover: "https://cdn.thegamesdb.net/images/original/boxart/front/4007-1.jpg", synopsis: "Luke Custer, um agente da Genome Cyber Force, descobre que pode se transformar em bestas monstruosas como lobisomem e dragão. Ele luta contra horrores biotecnológicos para recuperar sua memória e impedir uma ameaça global. O jogo mistura ação, mutações grotescas e clima de terror biotecnológico.", developer: "SEGA Wow", publisher: "SEGA", date: "27/01/2005", age: "Mature", platforms: ["PlayStation 2"], languageOption: "Sem Legenda", mediaType: "Físico" },
            { id: 47, title: "Assassin’s Creed Odyssey", cover: "https://cdn.thegamesdb.net/images/original/boxart/front/102951-1.jpg", synopsis: "Escreva sua própria odisseia épica e torne-se um lendário herói espartano. Molde seu destino em um mundo onde cada escolha importa. Testemunhe a grandeza da Grécia Antiga em meio à guerra.", developer: "Ubisoft Quebec", publisher: "Ubisoft", date: "05/10/2018", age: "Mature", platforms: ["PlayStation 4", "PlayStation 5", "Xbox One", "Xbox Series X/S", "Microsoft Windows", "Stadia"] },
             { id: 81, title: "Until Dawn", cover: "https://cdn.thegamesdb.net/images/original/boxart/front/24327-1.jpg", synopsis: "Em Until Dawn, oito amigos retornam a um chalé isolado nas montanhas Blackwood exatamente um ano após o misterioso desaparecimento das irmãs gêmeas Hannah e Beth. O reencontro, que deveria ser uma noite de diversão, rapidamente se transforma em um pesadelo quando forças sombrias passam a caçá-los.<br><br>Presos pela neve, sem contato com o mundo exterior e cercados por perigos desconhecidos, os jovens precisam tomar decisões difíceis para sobreviver até o amanhecer. Cada escolha feita — desde um simples diálogo até decisões de vida ou morte — altera o rumo da narrativa, determinando quem viverá e quem encontrará um destino brutal.<br><br>Misturando terror psicológico, lendas indígenas, criaturas aterradoras e segredos macabros escondidos na montanha, Until Dawn é uma experiência cinematográfica interativa onde o destino dos personagens está inteiramente nas mãos do jogador.", developer: "Supermassive Games", publisher: "Sony Computer Entertainment", date: "25/08/2015", age: "Mature", platforms: ["PlayStation 4", "PlayStation 5"], languageOption: "Dublado", mediaType: "Digital" }
        ];
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let games = [];
        let unsubscribeSnapshot = null;
        
        // --- INIT FIREBASE (Strict Pattern) ---
        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        };

        const initFirebaseListeners = (user) => {
             console.log("Usuário autenticado:", user.uid);
             
             // DETACH PREVIOUS LISTENER IF EXISTS
             if(unsubscribeSnapshot) unsubscribeSnapshot();
             
             // Use Private Path
             const gamesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'games');
             
             unsubscribeSnapshot = onSnapshot(query(gamesRef), (snapshot) => {
                 if (snapshot.empty) {
                     // Seeder logic
                     const storageKey = 'playstation-catalog-data-v11';
                     const saved = localStorage.getItem(storageKey);
                     let gamesToSeed = [];
                     
                     if (saved) {
                         try {
                             gamesToSeed = JSON.parse(saved);
                         } catch(e) { gamesToSeed = window.initialGamesData; }
                     } else {
                         gamesToSeed = window.initialGamesData;
                     }
                     
                     // Seed database (One time)
                     gamesToSeed.forEach(g => {
                         setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(g.id)), g);
                     });
                     return;
                 }

                 games = [];
                 snapshot.forEach(doc => {
                     games.push(doc.data());
                 });
                 
                 // Sort using window.getGenerationScore
                 games.sort((a, b) => {
                     const genA = window.getGenerationScore(a.platforms);
                     const genB = window.getGenerationScore(b.platforms);
                     if (genA !== genB) return genA - genB;
                     return a.title.localeCompare(b.title);
                 });

                 games.forEach(g => {
                     if (typeof g.mediaType === 'string') g.mediaType = [g.mediaType];
                     else if (!Array.isArray(g.mediaType)) g.mediaType = ["Físico"];
                 });

                 window.games = games; 
                 window.updateGameCount();
                 window.renderFilterOptions();
                 window.renderGrid();
                 
                 if (window.selectedGameId) window.renderModalContent();

              }, (error) => {
                  console.error("Erro no listener:", error);
                  window.showToast("Erro de sincronização", 'error');
              });
        };

        // --- GLOBAL OVERRIDES ---
        window.handleSaveGame = async () => {
            const titleInput = document.getElementById('new-title');
            if (!titleInput.value) {
                alert("Por favor, insira o título do jogo.");
                return;
            }
            const title = titleInput.value.toUpperCase();
            const editId = document.getElementById('edit-game-id').value;
            let gameData = {};
            
            const user = auth.currentUser;
            if(!user) { window.showToast("Erro de autenticação", 'error'); return; }

            if (editId) {
                const id = parseInt(editId);
                const existing = games.find(g => g.id === id);
                if (!existing) return;
                
                gameData = {
                    ...existing,
                    title: title,
                    cover: document.getElementById('new-cover').value || existing.cover,
                    synopsis: document.getElementById('new-synopsis').value || existing.synopsis,
                    developer: document.getElementById('new-developer').value || existing.developer,
                    publisher: document.getElementById('new-publisher').value || existing.publisher,
                    date: document.getElementById('new-date').value || existing.date,
                    age: document.getElementById('new-age').value,
                    platforms: window.newGamePlatforms.length > 0 ? window.newGamePlatforms : existing.platforms,
                    languageOption: window.newGameLanguage,
                    mediaType: window.newGameMediaType.length > 0 ? window.newGameMediaType : ["Físico"]
                };
            } else {
                const newId = games.length > 0 ? Math.max(...games.map(g => g.id)) + 1 : 1;
                gameData = {
                    id: newId,
                    title: title,
                    cover: document.getElementById('new-cover').value || 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Playstation_logo_colour.svg',
                    synopsis: document.getElementById('new-synopsis').value || "Sem sinopse.",
                    developer: document.getElementById('new-developer').value || "Desconhecido",
                    publisher: document.getElementById('new-publisher').value || "Desconhecido",
                    date: document.getElementById('new-date').value || "----",
                    age: document.getElementById('new-age').value,
                    platforms: window.newGamePlatforms.length > 0 ? window.newGamePlatforms : ["Desconhecido"],
                    languageOption: window.newGameLanguage,
                    mediaType: window.newGameMediaType.length > 0 ? window.newGameMediaType : ["Físico"],
                    loanStatus: 'available',
                    loanedTo: '',
                    isPlaying: false
                };
            }

            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(gameData.id)), gameData);
                window.showToast(`"${title}" salvo na nuvem!`);
                window.closeAddGameModal();
                if (window.isEditMode) window.toggleEditMode();
            } catch (e) {
                console.error(e);
                window.showToast("Erro ao salvar na nuvem.", 'error');
            }
        };

        window.deleteGame = async (id) => {
            const game = games.find(g => g.id === id);
            if (!game) return;
            const user = auth.currentUser;
            if(!user) return;

            if (confirm(`Tem certeza que deseja excluir "${game.title}" permanentemente?`)) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(id)));
                    window.showToast(`"${game.title}" removido!`, 'warning');
                } catch (e) {
                    console.error(e);
                    window.showToast("Erro ao excluir.", 'error');
                }
            }
        };

        const updateGameProperty = async (id, updates) => {
            const game = games.find(g => g.id === id);
            if (!game) return;
            const user = auth.currentUser;
            if(!user) return;
            
            const updatedGame = { ...game, ...updates };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(id)), updatedGame);
            } catch (e) {
                console.error(e);
                window.showToast("Erro ao atualizar.", 'error');
            }
        };

        window.togglePlaying = (id) => {
             const game = games.find(g => g.id === id);
             if(!game) return;
             if(!game.isPlaying) {
                 const playing = games.find(g => g.isPlaying);
                 if(playing) updateGameProperty(playing.id, { isPlaying: false });
             }
             updateGameProperty(id, { isPlaying: !game.isPlaying });
        };

        window.togglePlatform = (platformName) => {
            if (window.selectedGameId === null) return;
            const game = games.find(g => g.id === window.selectedGameId);
            if (!game) return;
            
            const normName = window.normalizePlatform(platformName);
            let newPlatforms = [...game.platforms];
            const exists = newPlatforms.some(p => window.normalizePlatform(p) === normName);
            
            if (exists) newPlatforms = newPlatforms.filter(p => window.normalizePlatform(p) !== normName);
            else newPlatforms.push(platformName);
            
            updateGameProperty(window.selectedGameId, { platforms: newPlatforms });
        };

        window.changeLanguageOption = (option) => {
            if (window.selectedGameId === null) return;
            updateGameProperty(window.selectedGameId, { languageOption: option });
        };

        window.changeMediaType = (type) => {
             if (window.selectedGameId === null) return;
             const game = games.find(g => g.id === window.selectedGameId);
             let currentMedia = Array.isArray(game.mediaType) ? [...game.mediaType] : [game.mediaType || "Físico"];
             if(currentMedia.includes(type)) currentMedia = currentMedia.filter(t => t !== type);
             else currentMedia.push(type);
             updateGameProperty(window.selectedGameId, { mediaType: currentMedia });
        };

        window.toggleLoanStatus = () => {
            if (window.selectedGameId === null) return;
            const game = games.find(g => g.id === window.selectedGameId);
            const currentStatus = game.loanStatus || 'available';
            const newStatus = currentStatus === 'available' ? 'loaned' : 'available';
            let updates = { loanStatus: newStatus };
            if(newStatus === 'available') updates.loanedTo = '';
            updateGameProperty(window.selectedGameId, updates);
        };

        window.saveLoanName = (name) => {
             if (window.selectedGameId === null) return;
             updateGameProperty(window.selectedGameId, { loanedTo: name });
        };

        window.handleRestore = (input) => {
            const file = input.files[0];
            if (!file) return;
            const user = auth.currentUser;
            if(!user) { window.showToast("Aguarde a autenticação...", 'warning'); return; }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                try {
                    let restoredGames = [];
                    // Try to parse as JSON first (Backup JSON)
                    try {
                        restoredGames = JSON.parse(content);
                    } catch (e) {
                         // Fallback to HTML parsing logic if needed (Legacy)
                         const regex = /const initialGamesData = (\[[\s\S]*?\]);/;
                         const match = content.match(regex);
                         if (match && match[1]) restoredGames = JSON.parse(match[1]);
                    }

                    if (Array.isArray(restoredGames) && restoredGames.length > 0) {
                        if(confirm(`Deseja substituir sua lista na NUVEM (${games.length} jogos) pela lista do backup (${restoredGames.length} jogos)?`)) {
                            window.showToast("Iniciando restauração...", 'info');
                            // Delete all existing
                            const deletePromises = games.map(g => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(g.id))));
                            await Promise.all(deletePromises);
                            
                            // Add new
                            const addPromises = restoredGames.map(g => setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'games', String(g.id)), g));
                            await Promise.all(addPromises);
                            
                            window.showToast("Backup restaurado na nuvem com sucesso!");
                        }
                    } else {
                        throw new Error("Formato inválido");
                    }
                } catch (err) { console.error(err); window.showToast("Erro ao ler backup.", 'error'); }
                input.value = '';
            };
            reader.readAsText(file);
        };
        
        // --- LOGOUT LOGIC ---
        window.handleLogout = async () => {
            try {
                await signOut(auth);
                localStorage.removeItem('isLoggedIn');
                location.reload(); 
            } catch(e) { console.error(e); }
        };

        // --- INIT APP ---
        onAuthStateChanged(auth, (user) => {
            if (user && localStorage.getItem('isLoggedIn') === 'true') {
                 initFirebaseListeners(user);
            } else if (localStorage.getItem('isLoggedIn') === 'true') {
                 // Re-authenticate if token expired but logged in locally
                 // Wait for auth to resolve or re-trigger anonymous
            }
        });
        
        // Trigger init if already logged in from previous session
        if (localStorage.getItem('isLoggedIn') === 'true') {
            initAuth();
        }

    </script>

    <script>
        // --- UI LOGIC (Standard Script) ---
        
        // Variables shared via window object
        window.selectedGameId = null;
        window.selectedPlatformFilter = "ALL";
        window.searchQuery = "";
        window.isEditMode = false;
        window.isDeleteMode = false;
        window.newGamePlatforms = [];
        window.newGameMediaType = [];
        window.newGameLanguage = "Sem Legenda";

        // --- UI Functions ---
        window.handleFilterChange = (value) => { window.selectedPlatformFilter = value; window.renderGrid(); };
        window.handleSearch = (value) => { window.searchQuery = value; window.renderGrid(); };
        window.resetFilter = () => {
            document.getElementById('platform-filter').value = "ALL";
            document.getElementById('search-input').value = "";
            window.searchQuery = "";
            window.handleFilterChange("ALL");
        };
        
        window.updateGameCount = () => {
            const grid = document.getElementById('games-grid');
            if(grid) {
                const count = grid.children.length;
                const el = document.getElementById('game-count');
                if(el) el.innerText = count;
            }
        };

        window.toggleEditMode = () => { window.isEditMode = !window.isEditMode; window.isDeleteMode = false; updateModeUI(); window.renderGrid(); };
        window.toggleDeleteMode = () => { window.isDeleteMode = !window.isDeleteMode; window.isEditMode = false; updateModeUI(); window.renderGrid(); };
        
        const updateModeUI = () => {
            const editBtn = document.getElementById('btn-edit-mode');
            const deleteBtn = document.getElementById('btn-delete-mode');
            const indicator = document.getElementById('mode-indicator');
            
            if(!editBtn || !deleteBtn) return;

            editBtn.className = "flex items-center gap-3 bg-slate-700 hover:bg-amber-600 text-slate-300 hover:text-white px-3 py-2 rounded-lg transition-all active:scale-95 w-full justify-start";
            deleteBtn.className = "flex items-center gap-3 bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white px-3 py-2 rounded-lg transition-all active:scale-95 w-full justify-start";
            indicator.className = "hidden w-full text-center py-2 text-sm font-bold uppercase tracking-wider text-white transition-colors relative z-30";
            
            if (window.isEditMode) {
                editBtn.className = "flex items-center gap-3 bg-amber-600 text-white ring-2 ring-amber-400 px-3 py-2 rounded-lg transition-all shadow-lg transform scale-105 w-full justify-start";
                indicator.textContent = "Modo de Edição: Selecione um jogo para alterar";
                indicator.classList.remove('hidden'); indicator.classList.add('bg-amber-600');
            } else if (window.isDeleteMode) {
                deleteBtn.className = "flex items-center gap-3 bg-red-600 text-white ring-2 ring-red-400 px-3 py-2 rounded-lg transition-all shadow-lg transform scale-105 w-full justify-start";
                indicator.textContent = "Modo de Exclusão: Selecione um jogo para remover";
                indicator.classList.remove('hidden'); indicator.classList.add('bg-red-600');
            }
        };

        window.renderGrid = () => {
            const grid = document.getElementById('games-grid');
            const playingSection = document.getElementById('playing-section');
            const emptyState = document.getElementById('empty-state');
            
            let filteredGames = window.games || [];

            if (window.selectedPlatformFilter !== "ALL") {
                const normalizedFilter = window.normalizePlatform(window.selectedPlatformFilter);
                filteredGames = filteredGames.filter(g => g.platforms.some(p => window.normalizePlatform(p) === normalizedFilter));
            }
            if (window.searchQuery) {
                const lowerQuery = window.searchQuery.toLowerCase();
                filteredGames = filteredGames.filter(g => g.title.toLowerCase().includes(lowerQuery));
            }

            const playingGame = filteredGames.find(g => g.isPlaying);
            const gridGames = filteredGames.filter(g => !g.isPlaying);

            if (playingGame) {
                const cover = window.getDisplayCover(playingGame);
                playingSection.classList.remove('hidden');
                playingSection.innerHTML = `
                    <div class="relative w-full bg-gradient-to-r from-purple-900/80 to-slate-900 border border-purple-500/50 rounded-xl overflow-hidden shadow-[0_0_30px_rgba(147,51,234,0.3)] p-6 flex flex-col md:flex-row items-center gap-8 animate-fade-in">
                        <div class="absolute inset-0 -z-10"><img src="${cover}" class="w-full h-full object-cover opacity-20 blur-xl scale-110" /><div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/50 to-transparent"></div></div>
                        <div class="relative shrink-0 group"><div class="w-48 h-64 rounded-lg overflow-hidden shadow-2xl ring-4 ring-purple-500 animate-pulse-glow cursor-pointer transition-transform hover:scale-105" onclick="openModal(${playingGame.id})"><img src="${cover}" class="w-full h-full object-cover" /></div></div>
                        <div class="flex-1 text-center md:text-left z-10"><div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-600 text-white text-xs font-bold uppercase tracking-wider mb-4 shadow-lg shadow-purple-600/40"><i data-lucide="gamepad-2" class="w-3 h-3 animate-bounce"></i> Jogando Atualmente</div><h2 class="text-3xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg leading-tight">${playingGame.title}</h2><p class="text-purple-200 text-lg mb-6 max-w-2xl line-clamp-2">${playingGame.synopsis}</p><button onclick="togglePlaying(${playingGame.id})" class="bg-red-500/20 hover:bg-red-500/40 text-red-200 border border-red-500/50 px-6 py-2 rounded-lg transition-all flex items-center gap-2 mx-auto md:mx-0 font-medium group"><i data-lucide="stop-circle" class="w-5 h-5 group-hover:text-red-100"></i> Parar de Jogar</button></div>
                    </div>`;
            } else {
                playingSection.classList.add('hidden');
                playingSection.innerHTML = '';
            }

            if (filteredGames.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                if(document.getElementById('game-count')) document.getElementById('game-count').innerText = 0;
                lucide.createIcons();
                return;
            }

            emptyState.classList.add('hidden');
            if(document.getElementById('game-count')) document.getElementById('game-count').innerText = filteredGames.length;

            grid.innerHTML = gridGames.map(game => {
                const isLoaned = game.loanStatus === 'loaned';
                let borderClass = 'hover:ring-2 hover:ring-blue-500 hover:shadow-[0_0_20px_rgba(37,99,235,0.3)]';
                if (window.isEditMode) borderClass = 'ring-4 ring-amber-500 shadow-[0_0_20px_rgba(245,158,11,0.4)] cursor-alias';
                if (window.isDeleteMode) borderClass = 'ring-4 ring-red-600 shadow-[0_0_20px_rgba(220,38,38,0.4)] cursor-not-allowed opacity-90 hover:opacity-100';
                if (isLoaned && !window.isEditMode && !window.isDeleteMode) borderClass = 'ring-4 ring-red-600 shadow-[0_0_20px_rgba(220,38,38,0.6)]';
                const displayCover = window.getDisplayCover(game);
                return `
                <div onclick="handleGridClick(${game.id})" class="group relative aspect-[3/4] bg-slate-800 rounded-lg overflow-hidden shadow-black shadow-lg cursor-pointer transition-all duration-300 hover:scale-105 ${borderClass} z-10">
                    <img src="${displayCover}" alt="${game.title}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 group-hover:brightness-110" />
                    ${isLoaned && !window.isDeleteMode ? `<div class="absolute top-2 right-2 flex flex-col items-end gap-1 z-20"><div class="w-3 h-3 bg-red-500 rounded-full shadow-[0_0_8px_rgba(239,68,68,0.8)] animate-pulse"></div>${game.loanedTo ? `<span class="text-[10px] font-bold text-white bg-red-600/90 px-1.5 py-0.5 rounded backdrop-blur-sm shadow-sm max-w-[80px] truncate border border-red-400/50">${game.loanedTo}</span>` : ''}</div><div class="absolute inset-0 bg-red-900/20 pointer-events-none mix-blend-overlay"></div>` : ''}
                    ${window.isEditMode ? `<div class="absolute inset-0 flex items-center justify-center bg-amber-900/40 backdrop-blur-[2px] opacity-0 group-hover:opacity-100 transition-opacity"><div class="bg-amber-500 text-white p-3 rounded-full shadow-lg"><i data-lucide="pencil" class="w-6 h-6"></i></div></div>` : ''}
                    ${window.isDeleteMode ? `<div class="absolute inset-0 flex items-center justify-center bg-red-900/60 backdrop-blur-[2px] opacity-0 group-hover:opacity-100 transition-opacity"><div class="bg-red-600 text-white p-3 rounded-full shadow-lg"><i data-lucide="trash-2" class="w-6 h-6"></i></div></div>` : ''}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };

        window.handleGridClick = (id) => {
            if (window.isEditMode) window.openAddGameModal(id);
            else if (window.isDeleteMode) deleteGame(id);
            else openModal(id);
        };

        window.openModal = (id) => {
             window.selectedGameId = id;
             window.renderModalContent();
             document.getElementById('modal-backdrop').classList.remove('hidden');
             document.body.style.overflow = 'hidden'; 
        };

        window.closeModal = () => {
             document.getElementById('modal-backdrop').classList.add('hidden');
             window.selectedGameId = null;
             document.body.style.overflow = '';
        };

        window.navigateGame = (dir) => {
            if (window.selectedGameId === null) return;
            
            // Re-calculate filtered list to find index
            let filteredGames = window.games || [];
            if (window.selectedPlatformFilter !== "ALL") {
                const normalizedFilter = window.normalizePlatform(window.selectedPlatformFilter);
                filteredGames = filteredGames.filter(g => g.platforms.some(p => window.normalizePlatform(p) === normalizedFilter));
            }
            if (window.searchQuery) {
                const lowerQuery = window.searchQuery.toLowerCase();
                filteredGames = filteredGames.filter(g => g.title.toLowerCase().includes(lowerQuery));
            }

            const currentIndex = filteredGames.findIndex(g => g.id === window.selectedGameId);
            if (currentIndex === -1) return;

            let newIndex = currentIndex + dir;
            if (newIndex < 0) newIndex = filteredGames.length - 1;
            if (newIndex >= filteredGames.length) newIndex = 0;

            const nextGame = filteredGames[newIndex];
            window.openModal(nextGame.id);
        };

        window.renderModalContent = () => {
            const game = window.games.find(g => g.id === window.selectedGameId);
            if (!game) return;
            const container = document.getElementById('modal-content');
            const displayCover = window.getDisplayCover(game);
            const platformSet = new Set(game.platforms.map(p => window.normalizePlatform(p)));
            const platformsHtml = window.MASTER_PLATFORM_LIST.map(plat => {
                const isAvailable = platformSet.has(plat);
                return `<button onclick="togglePlatform('${plat}')" class="flex items-center gap-3 p-3 rounded-md border text-left transition-all duration-200 group active:scale-95 hover:shadow-lg ${isAvailable ? 'bg-blue-950/40 border-blue-600/60 hover:bg-blue-900/50' : 'bg-slate-800/20 border-slate-700/50 hover:bg-slate-800/50 hover:border-slate-600'}"><div class="w-6 h-6 rounded flex items-center justify-center border transition-all duration-200 ${isAvailable ? 'bg-blue-600 border-blue-500 shadow-[0_0_10px_rgba(37,99,235,0.4)]' : 'bg-slate-800 border-slate-600 group-hover:border-slate-500'}">${isAvailable ? '<i data-lucide="check" class="w-3.5 h-3.5 text-white stroke-[3]"></i>' : ''}</div><span class="text-sm font-medium transition-colors duration-200 ${isAvailable ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'}">${plat}</span></button>`;
            }).join('');
            const langOptions = ["Dublado", "Legendado em Português", "Sem Legenda"].map(opt => {
                const isSelected = (game.languageOption || "Sem Legenda") === opt;
                return `<button onclick="changeLanguageOption('${opt}')" class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border ${isSelected ? 'bg-blue-600 text-white border-blue-500 shadow-[0_0_10px_rgba(37,99,235,0.4)]' : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:bg-slate-800 hover:text-slate-200'}">${opt}</button>`;
            }).join('');
            const mediaColorClass = window.getMediaColorClass(game.platforms);
            const mediaOptions = ["Físico", "Digital"].map(type => {
                const isSelected = Array.isArray(game.mediaType) ? game.mediaType.includes(type) : (game.mediaType === type);
                return `<button onclick="changeMediaType('${type}')" class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border flex items-center gap-2 ${isSelected ? mediaColorClass : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:bg-slate-800 hover:text-slate-200'}">${isSelected ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''} ${type}</button>`;
            }).join('');
            const isLoaned = game.loanStatus === 'loaned';
            const loanStatusText = isLoaned ? 'EMPRESTADO' : 'DISPONÍVEL';
            const loanStatusColor = isLoaned ? 'text-red-500' : 'text-green-500';
            const loanBgColor = isLoaned ? 'bg-red-500/10 border-red-500/50' : 'bg-green-500/10 border-green-500/50';
            const loanDotColor = isLoaned ? 'bg-red-500' : 'bg-green-500';

            container.innerHTML = `
                <button onclick="closeModal()" class="absolute top-4 right-4 md:hidden z-50 bg-black/50 p-2 rounded-full text-white hover:bg-black/70 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="w-full md:w-2/5 h-64 md:h-auto relative bg-black/50 shrink-0 flex items-center justify-center p-8 overflow-hidden"><div class="relative w-full max-w-[240px] aspect-[3/4] shadow-[0_20px_50px_rgba(0,0,0,0.8)] rounded-lg transition-transform transform hover:scale-105 duration-500 z-10"><img src="${displayCover}" alt="${game.title}" class="w-full h-full object-cover rounded-lg shadow-inner border-[1px] border-white/10" /><div class="absolute inset-0 rounded-lg bg-gradient-to-tr from-white/10 via-transparent to-transparent pointer-events-none"></div><div class="absolute inset-y-0 left-0 w-[2px] bg-white/20 rounded-l-lg"></div></div><div class="absolute inset-0 -z-0"><img src="${displayCover}" class="w-full h-full object-cover opacity-30 blur-xl scale-150 brightness-50" alt="" /><div class="absolute inset-0 bg-slate-900/40 mix-blend-multiply"></div></div></div>
                <div class="flex-1 flex flex-col min-h-0 overflow-hidden relative">
                    <div class="p-6 md:p-8 border-b border-slate-800 bg-slate-900/95 flex justify-between items-start shrink-0 z-10 shadow-sm">
                        <div class="w-full"><div class="flex justify-between items-start mb-2"><h2 class="text-3xl md:text-4xl font-bold text-white leading-tight">${game.title}</h2><button onclick="togglePlaying(${game.id})" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide transition-all transform active:scale-95 ${game.isPlaying ? 'bg-red-500/20 text-red-200 border border-red-500/50 hover:bg-red-500/40' : 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-600/20'}"><i data-lucide="${game.isPlaying ? 'stop-circle' : 'gamepad-2'}" class="w-4 h-4"></i> ${game.isPlaying ? 'Parar' : 'Jogar Agora'}</button></div><div class="flex flex-wrap gap-3 text-sm"><span class="px-2 py-1 bg-blue-900/50 text-blue-200 rounded border border-blue-800 flex items-center gap-1"><i data-lucide="building-2" class="w-3.5 h-3.5"></i> ${game.developer}</span><span class="px-2 py-1 bg-slate-800 text-slate-300 rounded border border-slate-700 flex items-center gap-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${game.date.split('—')[0]}</span></div></div>
                        <button onclick="closeModal()" class="hidden md:block text-slate-400 hover:text-white hover:bg-slate-800 p-2 rounded transition-colors absolute top-6 right-6"><i data-lucide="x" class="w-7 h-7"></i></button>
                    </div>
                    <div id="modal-scroll-body" class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-8 space-y-6">
                        <div class="prose prose-invert max-w-none"><h3 class="text-blue-400 text-sm font-bold uppercase tracking-wider mb-2">Sinopse</h3><p id="synopsis-text" class="text-slate-300 leading-relaxed text-lg transition-all duration-300">${game.synopsis}</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-950/50 p-4 rounded-lg border border-slate-800">
                            <div><span class="text-slate-500 text-xs uppercase block mb-1">Publicadora</span><span class="text-white font-medium">${game.publisher}</span></div>
                            <div><span class="text-slate-500 text-xs uppercase block mb-1">Idade do Jogo</span><div class="flex items-center gap-2 text-white font-medium"><i data-lucide="clock" class="w-4 h-4 text-blue-400"></i> ${window.getGameAge(game.date)}</div></div>
                            <div><span class="text-slate-500 text-xs uppercase block mb-1">Classificação</span><div class="flex items-center gap-2 text-white font-medium"><i data-lucide="shield-alert" class="w-4 h-4 text-red-500"></i> ${game.age}</div></div>
                        </div>
                        <div class="p-4 rounded-lg border ${loanBgColor} transition-colors duration-300">
                            <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="arrow-left-right" class="w-4 h-4"></i> Disponibilidade</h3>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                                <button onclick="toggleLoanStatus()" class="flex items-center gap-3 px-4 py-2 rounded-full bg-slate-900 border border-slate-700 hover:border-slate-500 transition-all"><div class="w-4 h-4 rounded-full ${loanDotColor} shadow-[0_0_8px_rgba(0,0,0,0.5)]"></div><span class="font-bold ${loanStatusColor}">${loanStatusText}</span></button>
                                <div class="${isLoaned ? 'block' : 'hidden'} flex-1 w-full sm:w-auto animate-fade-in"><input type="text" value="${game.loanedTo || ''}" placeholder="Nome da pessoa..." onchange="saveLoanName(this.value)" onkeydown="if(event.key === 'Enter') closeModal()" class="w-full bg-slate-900/50 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 placeholder-slate-500" /></div>
                            </div>
                        </div>
                        <div><h3 class="text-blue-400 text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="disc" class="w-4 h-4"></i> Mídia</h3><div class="flex flex-wrap gap-2">${mediaOptions}</div></div>
                        <div><h3 class="text-blue-400 text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Opções de Áudio</h3><div class="flex flex-wrap gap-2">${langOptions}</div></div>
                        <div><h3 class="text-blue-400 text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="globe" class="w-4 h-4"></i> Disponibilidade de Plataforma <span class="text-xs normal-case text-slate-500 font-normal ml-auto">(Clique para alterar)</span></h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-8">${platformsHtml}</div></div>
                    </div>
                </div>`;
            lucide.createIcons();
        };

        window.openAddGameModal = (editId = null) => {
            const modal = document.getElementById('add-game-modal');
            const titleEl = document.getElementById('modal-form-title');
            const saveBtn = document.getElementById('modal-save-btn');
            
            modal.classList.remove('hidden');

            if (editId) {
                const game = window.games.find(g => g.id === editId);
                if (!game) return;

                document.getElementById('edit-game-id').value = editId;
                titleEl.innerHTML = `<i data-lucide="pencil" class="w-6 h-6 text-amber-500"></i> Editar Jogo`;
                saveBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Salvar Alterações`;
                saveBtn.className = "px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg shadow-lg shadow-amber-900/20 transition-transform active:scale-95 flex items-center gap-2";

                document.getElementById('new-title').value = game.title;
                document.getElementById('new-cover').value = game.cover;
                window.updatePreview(game.cover);
                document.getElementById('new-synopsis').value = game.synopsis;
                document.getElementById('new-developer').value = game.developer;
                document.getElementById('new-publisher').value = game.publisher;
                document.getElementById('new-date').value = game.date;
                document.getElementById('new-age').value = game.age;

                window.newGamePlatforms = [...game.platforms];
                window.newGameMediaType = Array.isArray(game.mediaType) ? [...game.mediaType] : [game.mediaType || "Físico"];
                window.newGameLanguage = game.languageOption || "Sem Legenda";

            } else {
                document.getElementById('edit-game-id').value = "";
                titleEl.innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6 text-blue-500"></i> Adicionar Novo Jogo`;
                saveBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Salvar Jogo`;
                saveBtn.className = "px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-transform active:scale-95 flex items-center gap-2";

                document.getElementById('new-title').value = '';
                document.getElementById('new-cover').value = '';
                window.updatePreview('');
                document.getElementById('new-synopsis').value = '';
                document.getElementById('new-developer').value = '';
                document.getElementById('new-publisher').value = '';
                document.getElementById('new-date').value = '';
                document.getElementById('new-age').selectedIndex = 0;
                
                window.newGamePlatforms = [];
                window.newGameMediaType = [];
                window.newGameLanguage = "Sem Legenda";
            }
            window.renderNewGameSelectors();
            lucide.createIcons();
        };

        window.closeAddGameModal = () => { document.getElementById('add-game-modal').classList.add('hidden'); };
        window.updatePreview = (url) => {
            const img = document.getElementById('new-game-preview');
            const placeholder = document.getElementById('new-game-placeholder');
            if(url) { img.src = url; img.classList.remove('hidden'); placeholder.classList.add('hidden'); }
            else { img.classList.add('hidden'); placeholder.classList.remove('hidden'); }
        };
        
        window.renderNewGameSelectors = () => {
            const platformsContainer = document.getElementById('new-platforms-container');
            platformsContainer.innerHTML = window.MASTER_PLATFORM_LIST.map(plat => {
                const isSelected = window.newGamePlatforms.some(p => window.normalizePlatform(p) === window.normalizePlatform(plat));
                return `<button onclick="toggleNewPlatform('${plat}')" class="flex items-center gap-2 p-2 rounded border text-left text-xs transition-colors ${isSelected ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}"><div class="w-4 h-4 rounded border flex items-center justify-center ${isSelected ? 'bg-white border-white' : 'border-slate-500'}">${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-blue-600 stroke-[4]"></i>' : ''}</div><span>${plat}</span></button>`;
            }).join('');
            const audioContainer = document.getElementById('new-audio-container');
            const audioOpts = ["Dublado", "Legendado em Português", "Sem Legenda"];
            audioContainer.innerHTML = audioOpts.map(opt => {
                const isSelected = window.newGameLanguage === opt;
                return `<button onclick="toggleNewAudio('${opt}')" class="px-3 py-1.5 rounded-full text-xs font-medium border transition-colors ${isSelected ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}">${opt}</button>`;
            }).join('');
            const mediaContainer = document.getElementById('new-media-container');
            const mediaOpts = ["Físico", "Digital"];
            mediaContainer.innerHTML = mediaOpts.map(type => {
                const isSelected = window.newGameMediaType.includes(type);
                return `<button onclick="toggleNewMedia('${type}')" class="px-3 py-1.5 rounded-full text-xs font-medium border transition-colors flex items-center gap-2 ${isSelected ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}">${isSelected ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''} ${type}</button>`;
            }).join('');
            lucide.createIcons();
        };
        
        window.toggleNewPlatform = (plat) => {
            const normPlat = window.normalizePlatform(plat);
            if (window.newGamePlatforms.some(p => window.normalizePlatform(p) === normPlat)) window.newGamePlatforms = window.newGamePlatforms.filter(p => window.normalizePlatform(p) !== normPlat);
            else window.newGamePlatforms.push(plat);
            window.renderNewGameSelectors();
        };
        window.toggleNewAudio = (opt) => { window.newGameLanguage = opt; window.renderNewGameSelectors(); };
        window.toggleNewMedia = (type) => {
            if (window.newGameMediaType.includes(type)) window.newGameMediaType = window.newGameMediaType.filter(t => t !== type);
            else window.newGameMediaType.push(type);
            window.renderNewGameSelectors();
        };

        window.updateLoanName = (name) => {
            if (window.selectedGameId === null) return;
            const game = window.games.find(g => g.id === window.selectedGameId);
            game.loanedTo = name; 
        };

        window.toggleSynopsis = () => {
            const text = document.getElementById('synopsis-text');
            const isCollapsed = text.classList.contains('synopsis-clamp');
            if (isCollapsed) text.classList.remove('synopsis-clamp');
            else text.classList.add('synopsis-clamp');
        };

        window.showAppContent = () => {
             document.getElementById('login-screen').classList.add('opacity-0', 'transition-opacity', 'duration-500');
             setTimeout(() => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
             }, 500);
        };
        
        window.handleLogin = (e) => {
             e.preventDefault();
             const emailInput = document.getElementById('email');
             const passwordInput = document.getElementById('password');
             const errorMsg = document.getElementById('login-error');
             const VALID_EMAIL = "marcelobonacin14@gmail.com";
             const VALID_PASS = "m4rc3l00";

             if (emailInput.value === VALID_EMAIL && passwordInput.value === VALID_PASS) {
                 localStorage.setItem('isLoggedIn', 'true');
                 window.showAppContent();
                 // This triggers the auth listener
                 location.reload(); 
             } else {
                 errorMsg.classList.remove('hidden');
                 passwordInput.value = '';
                 passwordInput.focus();
             }
        };

        window.handleManualSave = () => {
             window.showToast("Dados já estão sincronizados na nuvem automaticamente!");
        };

        // --- NEW IMPLEMENTED FUNCTIONS ---

        window.toggleHeaderButtons = () => {
            const menu = document.getElementById('header-buttons');
            menu.classList.toggle('hidden');
        };

        window.exportToExcel = () => {
            if (!window.games || window.games.length === 0) {
                window.showToast("Nenhum dado para exportar.", "warning");
                return;
            }
            
            // Flatten data for Excel
            const data = window.games.map(g => ({
                ID: g.id,
                Título: g.title,
                Plataformas: g.platforms.join(", "),
                Mídia: Array.isArray(g.mediaType) ? g.mediaType.join(", ") : g.mediaType,
                Desenvolvedora: g.developer,
                Publicadora: g.publisher,
                Lançamento: g.date,
                Classificação: g.age,
                Status: g.loanStatus === 'loaned' ? `Emprestado para ${g.loanedTo}` : 'Disponível'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            
            // Styles (Basic)
            const wscols = [{wch:5}, {wch:30}, {wch:40}, {wch:15}, {wch:20}, {wch:20}, {wch:15}, {wch:15}, {wch:20}];
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Catálogo");
            XLSX.writeFile(wb, "Meus_Jogos.xlsx");
            window.showToast("Excel baixado com sucesso!");
        };

        window.downloadBackup = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.games));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_jogos.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            window.showToast("Backup JSON baixado!");
        };

        window.renderFilterOptions = () => {
            const select = document.getElementById('platform-filter');
            select.innerHTML = '<option value="ALL">Todas as Plataformas</option>' + 
                window.MASTER_PLATFORM_LIST.map(p => `<option value="${p}">${p}</option>`).join('');
            select.value = window.selectedPlatformFilter;
        };

        window.showResetScreen = () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('reset-screen').classList.remove('hidden');
        };
        
        window.showLoginScreen = () => {
            document.getElementById('reset-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };

        window.handleResetSubmit = (e) => {
            e.preventDefault();
            const msg = document.getElementById('reset-message');
            msg.textContent = "Se este email estiver cadastrado, você receberá um link em breve.";
            msg.classList.remove('hidden');
            msg.classList.add('text-green-500', 'bg-green-900/20', 'border-green-800');
        };

    </script>
</body>
</html>